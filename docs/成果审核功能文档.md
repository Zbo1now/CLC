# 成果审核功能开发文档

## 功能概述
实现了完整的成果审核系统，包括待审核列表、审核操作（通过/驳回）、已审核记录查询，并实现了审核通过后自动发币的功能。

## 技术架构

### 后端实现

#### 1. Model 层
**文件：** `src/main/java/com/campuscoin/model/admin/AdminAchievementListItem.java`
- 成果审核列表项视图对象
- 包含团队名称等关联信息
- 14个字段：id, teamId, teamName, category, subType, title, proofUrl, description, status, rewardCoins, rejectReason, reviewedBy, reviewedAt, createdAt

**文件：** `src/main/java/com/campuscoin/payload/PagedResponse.java`
- 分页响应对象
- 包含数据列表、总记录数、当前页码、每页大小、总页数

#### 2. DAO 层
**文件：** `src/main/java/com/campuscoin/dao/admin/AdminAchievementDao.java`
- 分页查询成果列表（带筛选条件）
  - 支持按状态（PENDING/APPROVED/REJECTED）筛选
  - 支持按成果类型筛选
  - 支持按团队名称模糊搜索
  - JOIN teams 表获取团队名称
- 统计成果总数（带筛选条件）
- 获取成果详情

**关键 SQL 特性：**
- 使用 MyBatis 动态 SQL（`<script>` 标签）
- 多条件筛选（WHERE 子句动态拼接）
- 分页查询（LIMIT offset, pageSize）
- 降序排列（ORDER BY created_at DESC）

#### 3. Service 层
**文件：** `src/main/java/com/campuscoin/service/admin/AdminAchievementService.java`

**核心方法：**

1. **listPaged()** - 分页查询成果列表
   - 参数：status, category, teamName, page, pageSize
   - 返回：PagedResponse<AdminAchievementListItem>
   - 日志记录：查询参数、结果数量

2. **approveAchievement()** - 审核通过并自动发币
   - 参数：achievementId, rewardCoins, reviewedBy
   - 业务流程：
     1. 检查成果是否存在
     2. 检查成果是否已审核（状态必须为 PENDING）
     3. 更新成果状态为 APPROVED
     4. 给团队发币（调用 TeamDao.addBalance()）
     5. 记录流水（调用 TransactionDao.create()）
     6. 记录管理员操作日志
   - 事务保证：@Transactional(rollbackFor = Exception.class)
   - 日志记录：审核过程、发币结果

3. **rejectAchievement()** - 审核驳回
   - 参数：achievementId, rejectReason, reviewedBy
   - 业务流程：
     1. 检查成果是否存在
     2. 检查成果是否已审核
     3. 更新成果状态为 REJECTED
     4. 记录管理员操作日志
   - 事务保证：@Transactional(rollbackFor = Exception.class)
   - 日志记录：驳回原因

#### 4. Controller 层
**文件：** `src/main/java/com/campuscoin/controller/admin/AdminAchievementController.java`

**RESTful API：**

1. **GET /api/admin/achievements** - 分页查询成果列表
   - 请求参数：status, category, teamName, page, pageSize
   - 响应：ApiResponse<PagedResponse<AdminAchievementListItem>>

2. **GET /api/admin/achievements/{id}** - 获取成果详情
   - 响应：ApiResponse<AdminAchievementListItem>

3. **POST /api/admin/achievements/{id}/approve** - 审核通过
   - 请求体：{ "rewardCoins": 100 }
   - 参数验证：奖励币值必须大于0
   - 响应：ApiResponse<Void>

4. **POST /api/admin/achievements/{id}/reject** - 审核驳回
   - 请求体：{ "rejectReason": "材料不符合要求" }
   - 参数验证：驳回原因不能为空
   - 响应：ApiResponse<Void>

### 前端实现

#### 1. API 模块
**文件：** `admin-web/src/api/achievement.js`
- getAchievementList() - 分页查询成果列表
- getAchievementDetail() - 获取成果详情
- approveAchievement() - 审核通过
- rejectAchievement() - 审核驳回

#### 2. 页面组件
**文件：** `admin-web/src/views/audit/index.vue`

**UI 模块：**

1. **筛选表单**
   - 审核状态下拉框（全部/待审核/已通过/已驳回）
   - 成果类型下拉框（论文/专利/竞赛/科研/其他）
   - 团队名称输入框（模糊搜索）
   - 搜索按钮、重置按钮

2. **统计卡片**
   - 待审核数量（橙色渐变图标）
   - 已通过数量（绿色渐变图标）
   - 已驳回数量（红色渐变图标）
   - 卡片悬停动画效果（transform: translateY(-4px)）

3. **成果列表表格**
   - 列：ID、团队名称、成果类型、成果标题、子类型、状态、奖励币值、提交时间、操作
   - 状态标签（颜色编码：待审核=warning、已通过=success、已驳回=danger）
   - 成果类型标签（不同颜色）
   - 奖励币值显示（带金币图标）
   - 操作按钮：查看详情、通过（仅待审核显示）、驳回（仅待审核显示）

4. **分页组件**
   - 总记录数显示
   - 每页大小切换（10/20/50/100）
   - 页码跳转

5. **成果详情对话框**
   - 描述列表展示成果信息
   - 附件链接（可点击查看）
   - 驳回原因（红色警告框显示）
   - 操作按钮：通过审核、驳回（仅待审核显示）

6. **审核通过对话框**
   - 显示成果标题、团队名称
   - 奖励币值输入框（数字输入框，范围1-10000，步长10）
   - 提示文字："审核通过后将自动给团队发放相应币值"
   - 表单验证：奖励币值必须大于0
   - 提交按钮带加载状态

7. **审核驳回对话框**
   - 显示成果标题、团队名称
   - 驳回原因文本框（多行输入，最多500字）
   - 字数统计
   - 表单验证：驳回原因5-500字
   - 提交按钮带加载状态

**样式特性：**
- 现代化卡片设计（圆角12px）
- 渐变色图标（linear-gradient）
- 卡片悬停效果（阴影+位移动画）
- 响应式布局（Grid）
- 统计卡片自适应（3列 → 2列 → 1列）

## 核心业务逻辑

### 审核通过流程
1. 用户点击"通过"按钮
2. 弹出审核通过对话框，输入奖励币值
3. 前端表单验证（币值范围1-10000）
4. 调用后端 API：POST /api/admin/achievements/{id}/approve
5. 后端执行：
   - 检查成果状态（必须为 PENDING）
   - 更新成果状态为 APPROVED
   - 给团队账户增加币值（TeamDao.addBalance）
   - 记录流水（TransactionDao.create，类型=ACHIEVEMENT_REWARD）
   - 记录操作日志（AdminOperationLogDao.insert）
6. 前端显示成功提示
7. 刷新列表和统计数据

### 审核驳回流程
1. 用户点击"驳回"按钮
2. 弹出审核驳回对话框，输入驳回原因
3. 前端表单验证（原因长度5-500字）
4. 调用后端 API：POST /api/admin/achievements/{id}/reject
5. 后端执行：
   - 检查成果状态（必须为 PENDING）
   - 更新成果状态为 REJECTED，记录驳回原因
   - 记录操作日志
6. 前端显示成功提示
7. 刷新列表和统计数据

## 数据库设计

### achievement_submissions 表
已存在的表结构：
```sql
CREATE TABLE achievement_submissions (
    id INT AUTO_INCREMENT PRIMARY KEY,
    team_id INT NOT NULL,
    category VARCHAR(50) NOT NULL,
    sub_type VARCHAR(100),
    title VARCHAR(255) NOT NULL,
    proof_url VARCHAR(500),
    description TEXT,
    status VARCHAR(20) DEFAULT 'PENDING',  -- PENDING/APPROVED/REJECTED
    reward_coins INT DEFAULT 0,
    reject_reason TEXT,
    reviewed_by VARCHAR(100),
    reviewed_at TIMESTAMP NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (team_id) REFERENCES teams(id)
);
```

### transactions 表
流水记录：
- txn_type = 'ACHIEVEMENT_REWARD'（成果奖励）
- amount = 奖励币值
- description = '成果奖励：{成果标题}'

### admin_operation_logs 表
管理员操作日志：
- operation_type = 'APPROVE_ACHIEVEMENT' 或 'REJECT_ACHIEVEMENT'
- target_type = 'ACHIEVEMENT'
- target_id = 成果ID
- operation_detail = 详细描述

## 技术要点

### 1. MyBatis 动态 SQL
- 使用 `<script>` 标签包裹动态 SQL
- 使用 `<where>` 和 `<if>` 实现条件筛选
- 注意 XML 转义：`<script>` 标签内使用 `&lt;`、`&gt;` 等 HTML 实体

### 2. 事务管理
- 审核操作使用 @Transactional 注解
- rollbackFor = Exception.class 确保所有异常都回滚
- 发币和记录流水必须在同一事务中

### 3. RESTful API 设计
- 统一使用 ApiResponse<T> 包装响应
- 使用 ok(message, data) 和 fail(message) 方法
- HTTP 方法语义化（GET 查询、POST 操作）

### 4. 前端状态管理
- 使用 reactive 管理筛选表单、分页、统计数据
- 使用 ref 管理列表数据、对话框状态、加载状态
- 表单验证使用 Element Plus 的 rules 机制

### 5. 用户体验优化
- 操作按钮带加载状态（:loading="submitting"）
- 实时统计数据更新
- 成功/失败提示消息（ElMessage）
- 卡片悬停动画效果

## 部署说明

### 后端
1. 编译项目：`mvn clean package -DskipTests`
2. 启动服务：`java -jar target/campuscoin-h5.jar`
3. 端口：8081

### 前端
1. 安装依赖：`cd admin-web && npm install`
2. 启动开发服务器：`npm run dev`
3. 端口：3000
4. 代理配置：/api -> http://localhost:8081

## 测试场景

### 1. 待审核列表查询
- 筛选条件：status=PENDING
- 验证：显示所有待审核成果

### 2. 审核通过
- 选择一条待审核成果
- 点击"通过"按钮
- 输入奖励币值：100
- 提交
- 验证：
  - 成果状态变为"已通过"
  - 团队币值增加100
  - 流水记录生成
  - 统计数据更新

### 3. 审核驳回
- 选择一条待审核成果
- 点击"驳回"按钮
- 输入驳回原因："材料不符合要求"
- 提交
- 验证：
  - 成果状态变为"已驳回"
  - 驳回原因记录
  - 统计数据更新

### 4. 已审核记录查询
- 筛选条件：status=APPROVED 或 REJECTED
- 验证：显示对应状态的成果列表

## 后续优化建议

1. **批量审核**：支持勾选多条记录进行批量审核
2. **附件预览**：在详情对话框中直接预览图片/PDF
3. **导出功能**：支持导出 Excel 格式的审核记录
4. **审核提醒**：待审核数量超过阈值时发送通知
5. **审核历史**：记录成果的所有审核操作历史
6. **撤销审核**：支持撤销已审核的成果（重置为待审核）
7. **自动审核规则**：配置自动审核规则（如币值范围）

## 开发日志

- 2025-12-17：完成成果审核功能开发
  - 创建后端 API（Model、DAO、Service、Controller）
  - 创建前端页面（筛选表单、列表、对话框）
  - 实现审核通过自动发币逻辑
  - 实现审核驳回记录原因
  - 添加统计卡片和实时更新
  - 优化 UI 设计（渐变图标、卡片动画）
